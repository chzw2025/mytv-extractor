name: Extract MyTV (Android Box Player)

on:
  workflow_dispatch:
  schedule:
    - cron: "2 */2 * * *"

jobs:
  fetch-mytv:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ è®¾ç½® Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      # 3ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          pip install cloudscraper

      # 4ï¸âƒ£ æŠ“å– MyTV.m3uï¼ˆå®Œæ•´æ¨¡æ‹Ÿæœºé¡¶ç›’ + ç»• Cloudflareï¼‰
      - name: Fetch MyTV.m3u
        run: |
          python3 - <<'EOF'
          import cloudscraper

          URL = "https://tv.iill.top/m3u/MyTV"
          OUTPUT = "MyTV.m3u"

          scraper = cloudscraper.create_scraper(
              browser={
                  'browser': 'chrome',
                  'platform': 'android',
                  'mobile': True
              }
          )

          headers = {
              "User-Agent": "AppleCoreMedia/1.0.0.7B367 (iPad; U; CPU OS 4_3_3 like Mac OS X)",
              "Accept": "*/*",
              "Range": "bytes=0-",
              "Connection": "close",
              "Icy-MetaData": "1",
              "Host": "tv.iill.top"
          }

          print("ğŸ“¡ æ­£åœ¨æŠ“å– MyTV...")
          resp = scraper.get(URL, headers=headers, timeout=20)

          print("HTTP çŠ¶æ€:", resp.status_code)
          print("å‰200å­—ç¬¦:", resp.text[:200])

          if resp.status_code == 200 and resp.text.startswith("#EXTM3U"):
              raw = resp.text.splitlines()
              filtered = []
              skip_next = False

              for line in raw:
                  # åˆ é™¤æŒ‡å®šé¢‘é“ï¼ˆEXTINF + æ’­æ”¾URLï¼‰
                  if "302.mp4" in line or "301.mp4" in line:
                      skip_next = False
                      continue

                  if "tvg-id=\"å…è²»è¨‚é–²\"" in line:
                      skip_next = True
                      continue

                  if skip_next:
                      skip_next = False
                      continue

                  filtered.append(line)

              final_content = "\n".join(filtered)

              with open(OUTPUT, "w", encoding="utf-8") as f:
                  f.write(final_content)

              print("ğŸ§¹ å·²æ¸…ç†æç¤ºé¢‘é“ï¼Œä¿ç•™è¡Œæ•°:", len(filtered))

          else:
              print("âš ï¸ å†…å®¹å¼‚å¸¸ï¼Œå·²ç”Ÿæˆ MyTV_error.html")
              with open("MyTV_error.html", "w", encoding="utf-8") as f:
                  f.write(resp.text)
          EOF

      # 5ï¸âƒ£ æäº¤å¹¶æ¨é€ MyTV.m3u
      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add MyTV.m3u || true
          git add MyTV_error.html || true
          git commit -m "Update MyTV.m3u via GitHub Actions" || echo "No changes to commit"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
